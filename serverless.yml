org: danwakeemserverless
app: rodger-api
service: rodger-api
configValidationMode: error

provider:
  name: aws
  versionFunctions: false
  runtime: nodejs14.x
  tracing:
    apiGateway: true
    lambda: true
  environment:
    STAGE: ${opt:stage}
    AWS_LAMBDA_EXEC_WRAPPER: /opt/otel-handler
    OPENTELEMETRY_COLLECTOR_CONFIG_FILE: /var/task/collector.yml
    OTEL_RESOURCE_ATTRIBUTES: orgUid=9MJvd98pmm7B77YdMQ,applicationName=platform-core,appUid=JKHcVVDxmYw4rmyrGb,deploymentUid=e0ab99cd-c44b-432d-82a9-6597864ed2d7,serviceName=kinesis-ingestion,stageName=${opt:stage}

plugins:
  - serverless-offline
  # - serverless-esbuild

custom:
  esbuild:
    packager: yarn
    external:
      - 'graphql'

package:
  individually: true
  patterns:
    - '!coverage/**'
    - '!.serverless/**'
    - '!src/**/*.test.js'
    - '!src/**/*.snap'
    - '!.*'
    - '!.github/*'
    - '!*.sh'
    - '!env.sample'
    - '!assets/**'
    - '!package.json'
    - '!yarn.lock'
    - '!README.md'
    - '!jest.config.js'

# This was build from the nodejs app in the https://github.com/open-telemetry/opentelemetry-lambda repo
layers:
  graphqlMetrics:
    package:
      artifact: layer.zip

functions:
  graphql:
    handler: src/graphql/index.handler
    timeout: 20
    events:
      - http:
          path: graphql
          method: post
          cors: true
    layers:
      - { Ref: GraphqlMetricsLambdaLayer }
      # This was deployed using the collector app in the https://github.com/open-telemetry/opentelemetry-lambda repo
      - arn:aws:lambda:us-east-1:377024778620:layer:otel-collector:10